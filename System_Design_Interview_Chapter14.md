# 14장 - 유튜브 설계

## 1단계 : 문제 이해 및 설계 범위 확정

- 중요한 기능은?
  - 비디오를 올리는 기능과 시청하는 기능
- 지원해야 하는 클라이언트
  - 모바일 앱, 웹 브라우저, 스마트 TV
- 일간 능동 사용자 수는?
  - 5백만(5million)
- 사용자가 이 제품에 평균적으로 소비하는 시간은?
  - 30분
- 다국어 지원 여부
  - 어떤 언어로도 이용 가능해야 함
- 지원하는 비디오 해상도
  - 현존하는 대부분의 비디오 종류와 해상도
- 암호화 필요 여부
  - 필요함
- 비디오 파일 크기에 제한은?
  - 최대 1GB로 제한
- 다른 회사의 클라우드 서비스를 활용할 수 있는지?
  - 가능
- 갖춰야 할 기능들
  - 빠른 비디오 업로드
  - 원활한 재생
  - 재생 품질 선택 가능
  - 낮은 인프라 비용
  - 높은 가용성, 규모 확장성, 안정성
  - 모바일 앱, 웹브라우저, 스마트 TV 지원

### 개략적 규모 추정

- DAU 5백만
- 한 사용자는 하루에 평균 5개 비디오 시청
- 10%의 사용자가 하루에 1 비디오 업로드
- 비디오 평균 크기 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량
  - 5백만 x 10% x 300MB = 150TB
- CDN 비용
  - 아마존 사용 시 매일 5백만 x 5비디오 x 0.3GB x $0.02 = $150,000 비용 발생 추정
  - 매우 비싸므로 비용을 줄이는 방법을 알아봐야 함

## 2단계 : 개략적 설계안 제시 및 동의 구하기

- CDN과 BLOB 스토리지는 기존 클라우드 서비스를 활용하는 이유
  - BLOB 저장소를 어떻게 구현할 것인지 상세한 설계는 모든 것을 밑바닥부터 만드는 것
  - 규모 확장이 쉬운 BLOB 저장소나 CDN을 만드는 것은 지극히 복잡하고 비용이 많이 듬
- 시스템의 컴포넌트
  - 단말 : 컴퓨터, 모바일 폰, 스마트 TV
  - CDN : 비디오는 CDN에 저장
  - API 서버 : 스트리밍을 제외한 모든 요청 담당

### 비디오 업로드 절차

- 컴포넌트
  - 사용자 : 유튜브를 시청하는 이용자
  - 로드밸런서 : API 서버 각각으로 고르게 요청을 분산
  - API 서버 : 비디오 스트리밍을 제외한 다른 모든 요청 처리
  - 메타데이터 데이터베이스 : 비디오의 메타데이터를 보관, 샤딩과 다중화 적용
  - 메타데이터 캐시 : 비디오 메타데이터, 사용자 객체는 캐시 (성능 향상을 위해)
  - 원본 저장소 : 원본 비디오를 보관할 대형 이진 파일 저장소
  - 트랜스코딩 서버 : 비디오 인코딩이라 부르기도 함, 트랜스코딩은 비디오의 포맷을 변환하는 절차(단말이나 대역폭 요구 사항에 맞게)
  - 트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
  - CDN : 비디오를 캐싱 하는 역할
  - 트랜스코딩 완료 큐 : 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐
  - 트랜스코딩 완료 핸들러 : 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들
- 프로세스 a: 비디오 업로드
  - 비디오를 원본 저장소에 업로드
  - 트랜스코딩 서버가 원본 저장소에서 비디오를 가져온 후 트랜스코딩 시작
  - 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
  - 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣음 (병렬적으로)
  - API 서버가 스트리밍 준비가 되었음을 알림
- 프로세스 b: 메타데이터 갱신
  - 원본 저장소에 파일이 업로드되는 동엔 단말에서 비디오 메타데이터 갱신 요청을 API 서버에 보냄
  - API 서버는 이정보로 메타데이터 캐시와 DB를 업데이트

### 비디오 스트리밍 절차

- 스트리밍 프로토콜
  - 비디오 스트리밍을 위한 표준화된 통신방법
  - MPEG-DASH
  - 애플 HLS
  - 마이크로소프트 스무드 스트리밍
  - 어도비 HTTP 동적 스트리밍
  - 프로토콜마다 지원하는 비디오 인코딩과 플레이어가 다름
- 비디오는 CDN에서 바로 스트리밍
  - 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송 담당

## 3단계 : 상세 설계

### 비디오 트랜스코딩

- 비트레이트
  - 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지 나타내는 단위
  - 비트 트레이가 높으면 일반적으로 고화질
- 비디오 트랜스코딩이 중요한 이유
  - 원본 비디오는 저장 공간을 많이 차지
  - 대부분의 단말, 브라우저는 특정 종류의 비디오 포맷만 지원
  - 네트워크 대역폭에 따라 화질을 정해서 보내주는 것이 바람직
  - 모바일 단말의 경우 네트워크 상황이 수시로 달라질 수 있음
- 인코딩 포맷 종류
  - 컨테이너 : 비디오 파일, 오디오, 메타데이터 (.avi, .mov, .mp4)
  - 코덱비디오 : 압축 및 압축 해제 알고리즘 (H.264, VP9, HEVC)

### 유향 비순환 그래프(DAG) 모델

- 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원해 줘야 함
- 적절한 수준의 추상화도 도입해야 함
- DAG 모델은 원본 비디오를 비디오, 오디오, 메타데이터 세 부분으로 나누어 처리
- 비디오 부분에 적용되는 작업
  - 검사 (품질, 손상 ...)
  - 비디오 인코딩 (다양한 해상도, 코텍, 비트레이트 조합으로 인코딩)
  - 섬네일 (사용자가 업로드한 이미지 or 비디오에서 자동 추출된 이미지로 만듦)
  - 워터마크 (식별 정보를 이미지 위에 오버레이로 표시)

### 비디오 트랜스코딩 아키텍처

- 전처리기, DAG 스케줄러, 자원 관리자, 작업 실행 서버, 임시 저장소로 구성
- 이 아키텍처가 동작한 결과로 인코딩된 비디오 생성
- 전처리기 역할
  - 비디오 분할 : 비디오 스트림을 GOP 단위로 쪼갬
  - DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 만듦
  - 데이터 캐시 : 전처리기는 분할된 비디오의 캐시이기도 함, GOP와 메타데이터를 임시 저장소에 보관
- DAG 스케줄러
  - DAG 그래프를 몇 개 단계로 분할 후 각각을 자원 관리자의 작업 큐에 넣음
- 자원 관리자
  - 자원 배분을 효과적으로 수행하는 역할
  - 세 개의 큐와 작업 스케줄러로 구성
  - 작업 큐 : 실행할 작업이 보관
  - 작업 서버 큐 : 작업 서버의 가용 상태 정보 보관
  - 실행 큐 : 현재 실행 중인 작업 및 작업 서버 정보 보관
  - 작업 스케줄러 : 최적의 작업/서버 조합을 골라 해당 작업 서버가 작업을 수행하도록 지시
- 작업 서버
  - DAG에 정의된 작업을 수행
- 임시 저장소
  - 여러 저장소 시스템을 활용해 구현 가능
  - 데이터의 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 시스템 선택 고려
- 인코딩된 비디오
  - 인코딩 파이프라인의 최종 결과물

### 시스템 최적화

- 속도 최적화: 비디오 병렬 업로드
  - 비디오를 GOP로 분할 후 병렬적으로 업로드하면 일부 실패 시 빠르게 업로드 재개 가능
- 속도 최적화: 업로드 센터를 사용자 근거리에 지정
  - 업로드 센터를 여러 곳에 두는 것
- 속도 최적화: 모든 절차를 병렬화
  - 느슨하게 결합된 시스템을 만든 뒤 병렬성을 높임
  - 메시지 큐를 도입해서 메시지 큐에 보관된 이벤트 각각을 인코딩 모듈이 병렬적으로 처리할 수 있게 함
- 안정성 최적화: 미리 사인된 업로드 URL
  - 허가받은 사용자만이 올바른 장소에 업로드하도록 하기 위해 미리 사인된 업로드 URL 이용
  - 클라이언트는 HTTP 서버에 POST 요청을 하여 미리 사인된 URL을 받음 (미리 사인된 URL은 아마존 S3에서 쓰이는 용어)
  - API 서버는 미리 사인된 URL을 돌려줌
  - 클라이언트는 해당 URL이 가리키는 위치에 비디오를 업로드
- 안정성 최적화: 비디오 보호
  - 비디오의 저작권 보호를 위해 DRM 시스템 도입, AES 암호화 (비디오를 암호화하고 접근 권한 설정하는 방식), 워터마크 사용
- 비용 최적화
  - CDN은 비용이 매우 비쌈
  - 유튜브의 비디오 스트리밍은 롱테일 분포를 따름 (인기 있는 비디오만 빈번히 재생)
  - 인기 있는 비디오는 CDN, 다른 비디오는 비디오 서버를 통해 재생하는 방법
  - 인기가 별로 없는 짧은 비디오는 필요할 때 인코딩하여 재생하는 방법
  - 특정 지역에서만 인기가 높은 비디오는 다른 지역에 옮길 필요 X
  - CDN을 직접 구축하고 인터넷 서비스 제공자와 제휴하는 방법 (초대형 프로젝트)
  - 최적화 전 시청 패턴을 분석하는 것이 중요

### 오류 처리

- 회복 가능 오류
  - 몇 번 재시도를 하면 해결되는 오류
  - 특정 비디오 세그먼트 트랜스 코딩 실패 등 ..
- 회복 불가능 오류
  - 시스템은 해당 비디오에 대한 작업을 중단 후 클라이언트에게 적절한 오류 코드를 반환해야 함
  - 비디오 포맷이 잘못되었다던가 하는 오류
- 시스템 컴포넌트에서 발생할 수 있는 오류들의 전형적 해결 방법
  - 업로드 오류 : 몇 회 재시도
  - 비디오 분할 오류 : 비디오를 서버로 전송
  - 트랜스코딩 오류 : 재시도
  - 전처리 오류 : DAG 그래프 재생성
  - DAG 스케줄러 오류 : 작업을 다시 스케줄링
  - 작업 관리자 큐에 장애 발생 : 사본(replica) 이용
  - 작업 서버 장애 : 다른 서버에서 해당 작업 재시도
  - API 서버 장애 : API 서버는 무상태 서버이므로 신규 요청은 다른 API 서버로 우회
  - 메타데이터 캐시 서버 장애 : 데이터 다중화로 대비, 장애 캐시는 새로운 서버로 교체
  - 메타데이터 데이터베이스 서버 장애 : 주 서버가 죽었을 시 부 서버 하나를 주 서버로 교체, 부 서버가 죽었을 시 다른 부서버를 통해 읽기 연산 처리, 죽은 서버는 새것으로 교체

## 4단계 : 마무리

- 추가로 논의할 수 있는 내용들
  - API 계층의 규모 확장성 확보 방안 (API 서버는 무상태 서버이므로 수평적 규모 확장이 가능)
  - 데이터베이스 계층의 규모 확장성 확보 방안 (데이터베이스의 다중화, 샤딩)
  - 라이브 스트리밍 (응답 지연이 좀 더 낮아야 하고 병렬화 필요성이 떨어짐, 오류 처리 방법을 달리해야 함)
  - 비디오 삭제 (사용자의 신고 절차를 통해 판별도 가능)
