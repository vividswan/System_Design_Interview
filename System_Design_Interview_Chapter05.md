# 5장 - 안정 해시 설계

- 수평적 규모 확장에서 요청이나 데이터를 서버에 균등하게 나누기 위해 안정 해시 기술을 사용

## 해시 키 재배치(rehash) 문제

- 부하를 균등하게 나누는 보편적 방법
  - serverIndex = hash(key) % N (N은 서버의 개수)
  - 서버 풀이 고정되어 있고 데이터 분포가 균등할 땐 잘 동작
  - 서버가 추가되거나 기존 서버 삭제 시 문제가 생김 (대규모 캐시 미스가 발생)

## 안정 해시

- 해시 테이블 크기가 조정될 때 평균적으로 (키의 개수 / 슬롯의 개수) 개의 키만 재배치하는 기술
  - 대부분의 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치함

### 해시 공간과 해시 링

- 해시 함수 f로 SHA-1을 사용
  - 0부터 2^160-1 범위
- 해시 공간을 그림으로 표현한 뒤 공간의 양쪽을 구부려 접으면 해시 링이 만들어짐

### 해시 서버

- 해시 함수 f를 사용하면 서버 IP나 이름을 링 위의 어떤 위치에 대응시킬 수 있음

### 해시 키

- 캐시 할 키 key0, key1, key2 ... 또한 해시 링 위의 어느 지점에 배치할 수 있음

### 서버 조회

- 어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버

### 서버 추가

- 서버를 추가하더라도 키 가운데 일부만 재배치하면 됨

### 서버 제거

- 하나의 서버가 제거되면 키 가운데 일부만 재배치 (그 서버로 배치되었던 키만, 나머지는 영향 X)

### 기본 구현법의 두 가지 문제

- 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는 게 불가능함
- 키의 균등 분포(uniform distribution)를 달성하기 어려움
- 두 문제를 해결하기 위해 가상 노드(복제)라 불리는 기법이 필요

### 가상 노드

- 실제 노드, 또는 서버를 가리키는 노드
- 각 서버는 여러 개의 가상 노드를 가짐으로써 하나가 아닌 여러 개 파티션을 관리해야 함
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해짐
  - 표준 편차가 작아져서 데이터가 고르게 분포되기 때문에
- 가상 노드를 늘리면 이를 저장할 데이터 공간이 더 많이 필요하기 때문에 타협적 결정이 필요함

### 재배치할 키 설정

- 서버가 추가되거나 제거되면 데이터 일부는 재배치
- 서버가 추가될 시 새로 추가된 노드로부터 그 반시계 방향에 있는 첫 번째 서버가 영향
- 서버가 삭제될 시 삭제된 노드로부터 그 반시계 방향에 있는 첫 번째 서버가 영향

## 마치며

- 안정 해시의 이점
  - 서버가 추가되거나 삭제될 때 재배치되는 키의 수 최소화
  - 데이터가 보다 균등하게 분포
  - 핫스팟 키 문제를 줄임 (특정한 샤드에 대한 접근을 줄임)
- 안정 해시의 예제
  - 아마존 다이나모 데이터베이스의 파티셔닝 관련 컴포넌트
  - 아파치 카산드라 클러스터에서의 데이터 파티셔닝
  - 디스코드의 채팅 애플리케이션
  - 아카마이 CDN
  - 매그레프 네트워크 부하 분산기
